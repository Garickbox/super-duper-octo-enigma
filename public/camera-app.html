<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–º–µ—Ä–∞ –¥–ª—è Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #ffffff;
            color: #212529;
            line-height: 1.6;
            padding: 0;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        header {
            background: #0088cc;
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            border-radius: 0 0 12px 12px;
        }

        h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
            margin: 5px 0;
            font-size: 16px;
        }

        .btn:hover {
            background: #006699;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #4cc9f0;
        }

        .btn-danger {
            background: #f72585;
        }

        .btn-warning {
            background: #ffb703;
        }

        .camera-preview {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
        }

        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .captured-image {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background: #000;
            border-radius: 12px;
            display: none;
        }

        .status-message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 12px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .photo-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        #cameraInfo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .camera-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .caption-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .caption-input:focus {
            outline: none;
            border-color: #0088cc;
        }

        .back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            color: #6c757d;
            margin-top: 10px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 500px;
                margin: 0 auto;
            }
            
            .camera-preview {
                height: 400px;
            }
            
            .captured-image {
                height: 400px;
            }
        }

        @media (max-width: 360px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="back-button" onclick="goBack()" style="display: none;">‚Üê</button>
            <h1>üì∑ –ö–∞–º–µ—Ä–∞ –≤ Telegram</h1>
            <p class="subtitle">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É</p>
        </header>

        <div class="card">
            <div class="camera-preview" id="cameraPreview">
                <video id="videoElement" autoplay playsinline></video>
                <div id="cameraInfo">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                    <div>–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">–ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É"</div>
                </div>
            </div>
            
            <img id="capturedImage" class="captured-image">
            
            <div class="camera-controls">
                <button class="btn btn-success" id="startCameraBtn">
                    üì∑ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button class="btn" id="captureBtn" disabled>
                    üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫
                </button>
                <button class="btn btn-danger" id="stopCameraBtn" disabled>
                    ‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
            </div>
        </div>

        <div class="card" id="photoPreviewCard" style="display: none;">
            <div class="photo-preview">
                <h3 style="margin-bottom: 10px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ</h3>
                <img id="previewImage" class="preview-image">
                <input type="text" id="photoCaption" class="caption-input" placeholder="–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" maxlength="200">
                <button class="btn btn-success" id="sendToBotBtn">
                    ‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É
                </button>
                <button class="btn btn-warning" id="retakePhotoBtn">
                    üîÑ –ü–µ—Ä–µ—Å–Ω—è—Ç—å —Ñ–æ—Ç–æ
                </button>
            </div>
        </div>

        <div id="statusMessage"></div>

        <div class="debug-info" id="debugInfo" style="display: none;">
            <strong>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
            <div id="debugContent"></div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let mediaStream = null;
        let currentPhotoData = null;
        
        // URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ - –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –ê–ö–¢–£–ê–õ–¨–ù–´–ô URL –ë–≠–ö–ï–ù–î–ê
        const SERVER_URL = 'https://your-backend-url.railway.app/api/send-photo';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
            tg.expand();
            tg.enableClosingConfirmation();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            showDebugInfo();
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('startCameraBtn').addEventListener('click', initializeCamera);
            document.getElementById('captureBtn').addEventListener('click', captureImage);
            document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
            document.getElementById('sendToBotBtn').addEventListener('click', sendPhotoToBot);
            document.getElementById('retakePhotoBtn').addEventListener('click', retakePhoto);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            showUserInfo();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–∞–º–µ—Ä—ã
            checkCameraSupport();
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function showUserInfo() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                const userName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                document.getElementById('cameraInfo').innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">üëã</div>
                    <div>–ü—Ä–∏–≤–µ—Ç, ${userName}!</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">–ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
                `;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∞–º–µ—Ä—ã
        function checkCameraSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ', 'error');
                document.getElementById('startCameraBtn').disabled = true;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
        async function initializeCamera() {
            try {
                showStatus('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...', 'info');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (mediaStream) {
                    stopCamera();
                }
                
                // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
                const constraints = {
                    video: { 
                        facingMode: "environment", // –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = mediaStream;
                
                // –ñ–¥–µ–º –ø–æ–∫–∞ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ
                videoElement.onloadedmetadata = () => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–º–µ—Ä–µ
                    document.getElementById('cameraInfo').style.display = 'none';
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                    document.getElementById('startCameraBtn').disabled = true;
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('stopCameraBtn').disabled = false;
                    
                    showStatus('‚úÖ –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'success');
                    updateDebugInfo('–ö–∞–º–µ—Ä–∞', '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
                let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.';
                } else {
                    errorMessage += '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                }
                
                showStatus(errorMessage, 'error');
                updateDebugInfo('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã', error.name);
            }
        }
        
        // –°–Ω–∏–º–æ–∫ —Å –∫–∞–º–µ—Ä—ã
        function captureImage() {
            const videoElement = document.getElementById('videoElement');
            const capturedImage = document.getElementById('capturedImage');
            const previewImage = document.getElementById('previewImage');
            
            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas –∫–∞–∫ —É –≤–∏–¥–µ–æ
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –≤–∏–¥–µ–æ –Ω–∞ canvas
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Data URL (—Å–∂–∞—Ç–æ–µ JPEG, –∫–∞—á–µ—Å—Ç–≤–æ 80%)
            currentPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            capturedImage.src = currentPhotoData;
            capturedImage.style.display = 'block';
            previewImage.src = currentPhotoData;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            videoElement.style.display = 'none';
            document.getElementById('photoPreviewCard').style.display = 'block';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
            document.querySelector('.back-button').style.display = 'flex';
            
            showStatus('‚úÖ –§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ', 'success');
            updateDebugInfo('–§–æ—Ç–æ', '–°–Ω—è—Ç–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ');
        }
        
        // –ü–µ—Ä–µ—Å–Ω—è—Ç—å —Ñ–æ—Ç–æ
        function retakePhoto() {
            const videoElement = document.getElementById('videoElement');
            const capturedImage = document.getElementById('capturedImage');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
            capturedImage.style.display = 'none';
            videoElement.style.display = 'block';
            document.getElementById('photoPreviewCard').style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
            document.querySelector('.back-button').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–¥–ø–∏—Å—å
            document.getElementById('photoCaption').value = '';
            
            currentPhotoData = null;
            showStatus('–°–¥–µ–ª–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å–Ω–∏–º–æ–∫', 'info');
            updateDebugInfo('–§–æ—Ç–æ', '–ü–µ—Ä–µ—Å—ä–µ–º–∫–∞');
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            const videoElement = document.getElementById('videoElement');
            videoElement.srcObject = null;
            
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = true;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('cameraInfo').style.display = 'block';
            document.getElementById('cameraInfo').innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                <div>–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">–ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É"</div>
            `;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
            document.querySelector('.back-button').style.display = 'none';
            
            showStatus('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞', 'info');
            updateDebugInfo('–ö–∞–º–µ—Ä–∞', '–í—ã–∫–ª—é—á–µ–Ω–∞');
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –±–æ—Ç—É
        async function sendPhotoToBot() {
            if (!currentPhotoData) {
                showStatus('‚ùå –ù–µ—Ç —Ñ–æ—Ç–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                return;
            }
            
            showStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –±–æ—Ç—É...', 'info');
            
            // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ Telegram Web App
            const user = tg.initDataUnsafe?.user;
            if (!user) {
                showStatus('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            const caption = document.getElementById('photoCaption').value;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            document.getElementById('sendToBotBtn').disabled = true;
            document.getElementById('sendToBotBtn').innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const result = await sendPhotoToServer(currentPhotoData, user.id, caption);
                
                if (result.success) {
                    showStatus('‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É!', 'success');
                    updateDebugInfo('–û—Ç–ø—Ä–∞–≤–∫–∞', '–£—Å–ø–µ—à–Ω–æ');
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        tg.close();
                    }, 2000);
                } else {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: ' + result.error, 'error');
                    updateDebugInfo('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: ' + error.message, 'error');
                updateDebugInfo('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', error.message);
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                document.getElementById('sendToBotBtn').disabled = false;
                document.getElementById('sendToBotBtn').innerHTML = '‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É';
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendPhotoToServer(photoData, userId, caption = '') {
            const response = await fetch(SERVER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    photo_data: photoData,
                    caption: caption
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // –ù–∞–∑–∞–¥ –∫ –≥–ª–∞–≤–Ω–æ–π
        function goBack() {
            window.location.href = 'index.html';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (type === 'success') {
                statusElement.classList.add('status-success');
            } else if (type === 'error') {
                statusElement.classList.add('status-error');
            } else if (type === 'warning') {
                statusElement.classList.add('status-warning');
            } else if (type === 'info') {
                statusElement.classList.add('status-info');
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (–∫—Ä–æ–º–µ –æ—à–∏–±–æ–∫)
            if (type !== 'error') {
                setTimeout(() => {
                    if (statusElement.textContent === message) {
                        statusElement.textContent = '';
                        statusElement.className = '';
                    }
                }, 5000);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        function showDebugInfo() {
            const user = tg.initDataUnsafe?.user;
            const debugInfo = `
                User ID: ${user?.id || 'N/A'}<br>
                Platform: ${tg.platform || 'N/A'}<br>
                Color Scheme: ${tg.colorScheme || 'N/A'}<br>
                Viewport: ${tg.viewportHeight} x ${tg.viewportWidth}<br>
                Backend URL: ${SERVER_URL}<br>
                Init Data: ${tg.initData ? 'Yes' : 'No'}
            `;
            
            document.getElementById('debugContent').innerHTML = debugInfo;
            document.getElementById('debugInfo').style.display = 'block';
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        function updateDebugInfo(key, value) {
            const debugContent = document.getElementById('debugContent');
            const currentContent = debugContent.innerHTML;
            const newEntry = `${key}: ${value}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –Ω–∞—á–∞–ª–æ
            debugContent.innerHTML = newEntry + '<br>' + currentContent.split('<br>').slice(0, 5).join('<br>');
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            updateDebugInfo('Global Error', e.error.message);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            updateDebugInfo('Promise Rejection', e.reason.message);
        });
    </script>
</body>
</html>