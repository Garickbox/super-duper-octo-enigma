<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–º–µ—Ä–∞ –¥–ª—è Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #ffffff;
            color: #212529;
            line-height: 1.6;
            padding: 0;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        header {
            background: #0088cc;
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            border-radius: 0 0 12px 12px;
        }

        h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
            margin: 5px 0;
        }

        .btn:hover {
            background: #006699;
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: #4cc9f0;
        }

        .btn-danger {
            background: #f72585;
        }

        .camera-preview {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 15px;
        }

        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .captured-image {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background: #000;
            border-radius: 12px;
            display: none;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 12px;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .photo-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
        }

        #cameraInfo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∑ –ö–∞–º–µ—Ä–∞ –≤ Telegram</h1>
            <p>–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É</p>
        </header>

        <div class="card">
            <div class="camera-preview" id="cameraPreview">
                <video id="videoElement" autoplay playsinline></video>
                <div id="cameraInfo">–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>
            </div>
            
            <img id="capturedImage" class="captured-image">
            
            <div class="media-controls">
                <button class="btn btn-success" id="startCameraBtn">
                    üì∑ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button class="btn" id="captureBtn" disabled>
                    üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫
                </button>
                <button class="btn btn-danger" id="stopCameraBtn" disabled>
                    ‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
            </div>
        </div>

        <div class="card" id="photoPreviewCard" style="display: none;">
            <div class="photo-preview">
                <img id="previewImage" class="preview-image">
                <input type="text" id="photoCaption" placeholder="–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                <button class="btn btn-success" id="sendToBotBtn">
                    ‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É
                </button>
                <button class="btn" id="retakePhotoBtn">
                    üîÑ –ü–µ—Ä–µ—Å–Ω—è—Ç—å —Ñ–æ—Ç–æ
                </button>
            </div>
        </div>

        <div id="statusMessage"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let mediaStream = null;
        let currentPhotoData = null;
        
        // URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ Render (–ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ –≤–∞—à URL –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)
        const SERVER_URL = 'https://your-app.onrender.com/api/send-photo';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
            tg.expand();
            tg.enableClosingConfirmation();
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('startCameraBtn').addEventListener('click', initializeCamera);
            document.getElementById('captureBtn').addEventListener('click', captureImage);
            document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
            document.getElementById('sendToBotBtn').addEventListener('click', sendPhotoToBot);
            document.getElementById('retakePhotoBtn').addEventListener('click', retakePhoto);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            showUserInfo();
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function showUserInfo() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                const userName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                document.getElementById('cameraInfo').textContent = `–ü—Ä–∏–≤–µ—Ç, ${userName}! –ù–∞–∂–º–∏ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É"`;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
        async function initializeCamera() {
            try {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (mediaStream) {
                    stopCamera();
                }
                
                // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
                const constraints = {
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = mediaStream;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–º–µ—Ä–µ
                document.getElementById('cameraInfo').style.display = 'none';
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('stopCameraBtn').disabled = false;
                
                showStatus('–ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
                showStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'error');
            }
        }
        
        // –°–Ω–∏–º–æ–∫ —Å –∫–∞–º–µ—Ä—ã
        function captureImage() {
            const videoElement = document.getElementById('videoElement');
            const capturedImage = document.getElementById('capturedImage');
            const previewImage = document.getElementById('previewImage');
            
            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Data URL (—Å–∂–∞—Ç–æ–µ JPEG)
            currentPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            capturedImage.src = currentPhotoData;
            capturedImage.style.display = 'block';
            previewImage.src = currentPhotoData;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            videoElement.style.display = 'none';
            document.getElementById('photoPreviewCard').style.display = 'block';
            
            showStatus('–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ üì∏', 'success');
        }
        
        // –ü–µ—Ä–µ—Å–Ω—è—Ç—å —Ñ–æ—Ç–æ
        function retakePhoto() {
            const videoElement = document.getElementById('videoElement');
            const capturedImage = document.getElementById('capturedImage');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
            capturedImage.style.display = 'none';
            videoElement.style.display = 'block';
            document.getElementById('photoPreviewCard').style.display = 'none';
            
            currentPhotoData = null;
            showStatus('–°–¥–µ–ª–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å–Ω–∏–º–æ–∫', 'success');
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            const videoElement = document.getElementById('videoElement');
            videoElement.srcObject = null;
            
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = true;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('cameraInfo').style.display = 'block';
            document.getElementById('cameraInfo').textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞';
            
            showStatus('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞', 'success');
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –±–æ—Ç—É
        async function sendPhotoToBot() {
            if (!currentPhotoData) {
                showStatus('–ù–µ—Ç —Ñ–æ—Ç–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                return;
            }
            
            showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –±–æ—Ç—É...', 'success');
            
            // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ Telegram Web App
            const user = tg.initDataUnsafe?.user;
            if (!user) {
                showStatus('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            const caption = document.getElementById('photoCaption').value;
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const result = await sendPhotoToServer(currentPhotoData, user.id, caption);
                
                if (result.success) {
                    showStatus('‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É!', 'success');
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        tg.close();
                    }, 2000);
                } else {
                    showStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ:', error);
                showStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: ' + error.message, 'error');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendPhotoToServer(photoData, userId, caption = '') {
            const response = await fetch(SERVER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                'Accept': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    photo_data: photoData,
                    caption: caption
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            if (type === 'success') {
                statusElement.classList.add('status-success');
            } else if (type === 'error') {
                statusElement.classList.add('status-error');
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = '';
            }, 5000);
        }
    </script>
</body>
</html>
