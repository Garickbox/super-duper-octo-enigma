<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–º–µ—Ä–∞ –¥–ª—è Telegram - –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ì–æ—Ä—á–∞–∫–æ–≤</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        }
        body { 
            background: #fff; 
            padding: 15px; 
            color: #333;
        }
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
        }
        header { 
            background: #0088cc; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            border-radius: 12px; 
            margin-bottom: 15px; 
        }
        .user-badge { 
            background: rgba(255,255,255,0.2); 
            padding: 8px 15px; 
            border-radius: 20px; 
            font-size: 0.9em; 
            margin-top: 5px; 
            display: inline-block;
        }
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .btn { 
            background: #0088cc; 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            width: 100%; 
            margin: 5px 0; 
            font-size: 16px; 
            cursor: pointer; 
            transition: all 0.3s; 
            font-weight: 500;
        }
        .btn:hover { 
            background: #006699; 
            transform: translateY(-1px); 
        }
        .btn:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none; 
        }
        .btn:active { 
            transform: translateY(0); 
        }
        .btn-secondary { 
            background: #6c757d; 
        }
        .btn-secondary:hover { 
            background: #545b62; 
        }
        .camera-preview { 
            width: 100%; 
            height: 300px; 
            background: #000; 
            border-radius: 12px; 
            position: relative; 
            margin-bottom: 15px; 
            overflow: hidden; 
        }
        .camera-preview video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        #cameraInfo { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            color: white; 
            text-align: center; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 8px; 
            text-align: center; 
            font-weight: 500; 
        }
        .success { 
            background: #d4ffd4; 
            color: #006400; 
            border: 1px solid #006400; 
        }
        .error { 
            background: #ffd4d4; 
            color: #640000; 
            border: 1px solid #640000; 
        }
        .info { 
            background: #d4eaff; 
            color: #004064; 
            border: 1px solid #004064; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #856404; 
        }
        #previewImage { 
            width: 100%; 
            border-radius: 8px; 
            margin: 10px 0; 
            max-height: 300px; 
            object-fit: contain; 
        }
        #photoCaption { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            font-size: 16px; 
        }
        .log-panel { 
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 10px; 
            margin: 10px 0; 
            background: #f8f9fa; 
        }
        .log-entry { 
            font-family: 'Courier New', monospace; 
            font-size: 0.8rem; 
            margin: 2px 0; 
            padding: 2px 5px; 
            border-radius: 3px; 
            word-break: break-all;
        }
        .log-info { 
            background: #e8f5e8; 
            color: #2d5016; 
        }
        .log-error { 
            background: #ffe8e8; 
            color: #8b0000; 
        }
        .log-warn { 
            background: #fff3cd; 
            color: #856404; 
        }
        .log-debug { 
            background: #e3f2fd; 
            color: #0d47a1; 
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .info-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        .info-label {
            font-size: 0.8rem;
            color: #666;
        }
        .info-value {
            font-weight: bold;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∑ –ö–∞–º–µ—Ä–∞ –≤ Telegram</h1>
            <div class="user-badge">üë§ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ì–æ—Ä—á–∞–∫–æ–≤ (ID: 1189539923)</div>
            <p>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ</p>
        </header>

        <div class="card">
            <div class="camera-preview">
                <video id="videoElement" autoplay playsinline></video>
                <div id="cameraInfo">
                    <div style="font-size: 48px;">üì∑</div>
                    <div>–ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É"</div>
                </div>
            </div>
            
            <button class="btn" id="startCameraBtn">üì∑ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button class="btn" id="captureBtn" disabled>üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
            <button class="btn" id="stopCameraBtn" disabled>‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        </div>

        <div class="card" id="photoPreviewCard" style="display: none;">
            <h3>üì∑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ</h3>
            <img id="previewImage" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
            <input type="text" id="photoCaption" placeholder="–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" maxlength="200">
            <button class="btn" id="sendToBotBtn">‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
            <button class="btn" id="retakePhotoBtn">üîÑ –°–Ω—è—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ</button>
        </div>

        <div id="statusMessage"></div>

        <div class="card">
            <h4>üìä –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h4>
            <div class="log-panel" id="operationLogs">
                <div class="log-entry log-info">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. User ID: 1189539923</div>
            </div>
            <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>

        <div class="card" style="text-align: center; background: #f8f9fa;">
            <h4>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ</h4>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">User ID</div>
                    <div class="info-value">1189539923</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞</div>
                    <div class="info-value" id="connectionStatus">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                    <div class="info-value" id="responseTime">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ</div>
                    <div class="info-value" id="photoSize">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const YOUR_USER_ID = 1189539923;
        let mediaStream = null;
        let currentPhotoData = null;
        let operationLogs = [];

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º URL —Å–µ—Ä–≤–µ—Ä–∞
        const SERVER_URL = window.location.origin + '/api/send-photo';

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type
            };
            operationLogs.push(logEntry);
            
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${type}`;
            logElement.textContent = `[${timestamp}] ${message}`;
            
            const logsContainer = document.getElementById('operationLogs');
            logsContainer.appendChild(logElement);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –≤ localStorage (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 50 –∑–∞–ø–∏—Å–µ–π)
            if (operationLogs.length > 50) {
                operationLogs = operationLogs.slice(-50);
            }
            localStorage.setItem('cameraAppLogs', JSON.stringify(operationLogs));
        }

        function clearLogs() {
            operationLogs = [];
            document.getElementById('operationLogs').innerHTML = '<div class="log-entry log-info">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
            localStorage.removeItem('cameraAppLogs');
        }

        function loadSavedLogs() {
            const savedLogs = localStorage.getItem('cameraAppLogs');
            if (savedLogs) {
                operationLogs = JSON.parse(savedLogs);
                const logsContainer = document.getElementById('operationLogs');
                logsContainer.innerHTML = '';
                operationLogs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = `log-entry log-${log.type}`;
                    logElement.textContent = `[${log.timestamp}] ${log.message}`;
                    logsContainer.appendChild(logElement);
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–º–µ—Ä–µ —Ñ–æ—Ç–æ
        function updatePhotoSizeInfo() {
            const photoSizeElement = document.getElementById('photoSize');
            if (currentPhotoData) {
                const sizeKB = Math.round(currentPhotoData.length / 1024);
                photoSizeElement.textContent = `${sizeKB} KB`;
                photoSizeElement.style.color = sizeKB > 1000 ? '#e74c3c' : '#27ae60';
            } else {
                photoSizeElement.textContent = '-';
                photoSizeElement.style.color = '#333';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize buttons
            document.getElementById('startCameraBtn').addEventListener('click', initializeCamera);
            document.getElementById('captureBtn').addEventListener('click', captureImage);
            document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
            document.getElementById('sendToBotBtn').addEventListener('click', sendPhotoToBot);
            document.getElementById('retakePhotoBtn').addEventListener('click', retakePhoto);
            
            // Load saved logs and check server connection
            loadSavedLogs();
            checkServerConnection();
            
            addLog('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'info');
            
            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±—Ä–∞—É–∑–µ—Ä–µ
            addLog(`User Agent: ${navigator.userAgent}`, 'debug');
            addLog(`–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞: ${screen.width}x${screen.height}`, 'debug');
            addLog(`–ü–æ–¥–¥–µ—Ä–∂–∫–∞ camera: ${!!navigator.mediaDevices}`, 'debug');
            addLog(`–ü–æ–¥–¥–µ—Ä–∂–∫–∞ canvas: ${!!document.createElement('canvas').getContext}`, 'debug');
        });

        async function checkServerConnection() {
            const startTime = Date.now();
            try {
                const response = await fetch(window.location.origin + '/api/bot-status');
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    document.getElementById('connectionStatus').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    document.getElementById('connectionStatus').style.color = 'green';
                    document.getElementById('responseTime').textContent = responseTime + 'ms';
                    document.getElementById('responseTime').style.color = responseTime < 500 ? 'green' : responseTime < 1000 ? 'orange' : 'red';
                    addLog(`–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω (–æ—Ç–≤–µ—Ç: ${responseTime}ms)`, 'info');
                    
                    // –ï—Å–ª–∏ –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–º
                    if (data.status === 'ACTIVE') {
                        addLog(`–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω: ${data.bot.first_name} (@${data.bot.username})`, 'info');
                    }
                } else {
                    throw new Error(data.error || 'Server error');
                }
            } catch (error) {
                document.getElementById('connectionStatus').textContent = '‚ùå –û—à–∏–±–∫–∞';
                document.getElementById('connectionStatus').style.color = 'red';
                document.getElementById('responseTime').textContent = '–û—à–∏–±–∫–∞';
                document.getElementById('responseTime').style.color = 'red';
                addLog(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${error.message}`, 'error');
            }
        }

        async function initializeCamera() {
            try {
                addLog('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...', 'info');
                showStatus('üîç –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...', 'info');
                
                if (mediaStream) {
                    stopCamera();
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                const constraints = {
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('videoElement');
                video.srcObject = mediaStream;
                
                video.onloadedmetadata = () => {
                    document.getElementById('cameraInfo').style.display = 'none';
                    document.getElementById('startCameraBtn').disabled = true;
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('stopCameraBtn').disabled = false;
                    
                    addLog('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'info');
                    showStatus('‚úÖ –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'success');
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
                    const track = mediaStream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    addLog(`–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–∏–¥–µ–æ: ${settings.width}x${settings.height}`, 'debug');
                };

                video.onerror = () => {
                    addLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞', 'error');
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ', 'error');
                };
                
            } catch (error) {
                console.error('Camera error:', error);
                let errorMessage = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += '–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É.';
                } else {
                    errorMessage += error.message;
                }
                
                addLog(errorMessage, 'error');
                showStatus('‚ùå ' + errorMessage, 'error');
            }
        }

        function captureImage() {
            const video = document.getElementById('videoElement');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas —Ä–∞–≤–Ω—ã–º–∏ –≤–∏–¥–µ–æ
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –≤–∏–¥–µ–æ –Ω–∞ canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            try {
                // –°–æ–∑–¥–∞–µ–º JPEG —Å —Ö–æ—Ä–æ—à–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º (0.85 - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∫–∞—á–µ—Å—Ç–≤–æ–º –∏ —Ä–∞–∑–º–µ—Ä–æ–º)
                currentPhotoData = canvas.toDataURL('image/jpeg', 0.85);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                if (!currentPhotoData || currentPhotoData.length < 100) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –î–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–µ.');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                document.getElementById('previewImage').src = currentPhotoData;
                video.style.display = 'none';
                document.getElementById('photoPreviewCard').style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—Ä–µ
                updatePhotoSizeInfo();
                
                const photoSize = Math.round(currentPhotoData.length / 1024);
                addLog(`–§–æ—Ç–æ –∑–∞—Ö–≤–∞—á–µ–Ω–æ (—Ä–∞–∑–º–µ—Ä: ${photoSize} KB, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${canvas.width}x${canvas.height})`, 'info');
                showStatus('‚úÖ –§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ', 'success');
                
            } catch (error) {
                console.error('Error capturing image:', error);
                addLog(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ: ${error.message}`, 'error');
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ: ' + error.message, 'error');
            }
        }

        function retakePhoto() {
            document.getElementById('videoElement').style.display = 'block';
            document.getElementById('photoPreviewCard').style.display = 'none';
            document.getElementById('photoCaption').value = '';
            currentPhotoData = null;
            updatePhotoSizeInfo();
            addLog('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –Ω–æ–≤–æ–º—É —Å–Ω–∏–º–∫—É', 'info');
            showStatus('üì∑ –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É —Å–Ω–∏–º–∫—É', 'info');
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => {
                    track.stop();
                });
                mediaStream = null;
            }
            document.getElementById('videoElement').srcObject = null;
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = true;
            document.getElementById('cameraInfo').style.display = 'block';
            addLog('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞', 'info');
            showStatus('‚èπÔ∏è –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞', 'info');
        }

        async function sendPhotoToBot() {
            if (!currentPhotoData) {
                addLog('–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–µ–∑ —Ñ–æ—Ç–æ', 'error');
                showStatus('‚ùå –ù–µ—Ç —Ñ–æ—Ç–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                return;
            }
            
            const caption = document.getElementById('photoCaption').value.trim();
            const photoSize = Math.round(currentPhotoData.length / 1024);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ (Telegram –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ~10MB)
            if (photoSize > 8000) {
                addLog(`–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ: ${photoSize} KB. Telegram –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω–∏—Ç—å.`, 'warn');
                showStatus('‚ö†Ô∏è –§–æ—Ç–æ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–µ, –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è...', 'warning');
            }
            
            addLog(`–ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ (—Ä–∞–∑–º–µ—Ä: ${photoSize} KB, –ø–æ–¥–ø–∏—Å—å: "${caption || '–Ω–µ—Ç'}")`, 'info');
            showStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –≤ Telegram...', 'info');
            
            const sendBtn = document.getElementById('sendToBotBtn');
            const originalText = sendBtn.innerHTML;
            const startTime = Date.now();
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: YOUR_USER_ID,
                        photo_data: currentPhotoData,
                        caption: caption
                    })
                });

                const result = await response.json();
                const duration = Date.now() - startTime;
                
                if (result.success) {
                    addLog(`–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram (ID: ${result.message_id}, –≤—Ä–µ–º—è: ${duration}ms)`, 'info');
                    showStatus('‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!', 'success');
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–¥–ø–∏—Å–∏
                    document.getElementById('photoCaption').value = '';
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        retakePhoto();
                        stopCamera();
                    }, 3000);
                } else {
                    addLog(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.error}`, 'error');
                    
                    // –î–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    let userErrorMessage = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
                    if (result.error.includes('Wrong padding')) {
                        userErrorMessage = '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ –µ—â–µ —Ä–∞–∑.';
                    } else if (result.error.includes('file is too big')) {
                        userErrorMessage = '–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ —Å –º–µ–Ω—å—à–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º.';
                    } else if (result.error.includes('chat not found')) {
                        userErrorMessage = '–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start).';
                    }
                    
                    showStatus(`‚ùå ${userErrorMessage}`, 'error');
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                addLog(`–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message} (–≤—Ä–µ–º—è: ${duration}ms)`, 'error');
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            }
        }

        function showStatus(message, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = 'status ' + type;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            if (type === 'success') {
                setTimeout(() => {
                    if (el.textContent === message) {
                        el.textContent = '';
                    }
                }, 5000);
            }
            
            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 8 —Å–µ–∫—É–Ω–¥
            if (type === 'warning') {
                setTimeout(() => {
                    if (el.textContent === message) {
                        el.textContent = '';
                    }
                }, 8000);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
        window.addEventListener('beforeunload', () => {
            if (mediaStream) {
                addLog('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ, –∫–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
                stopCamera();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && mediaStream) {
                addLog('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞, –∫–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
                stopCamera();
            }
        });
    </script>
</body>
</html>
